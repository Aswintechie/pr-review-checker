#!/bin/bash
# auto-deploy.sh - Production deployment script for pr-review-checker

set -e  # Exit on error

LOG_FILE="/home/aswin/pr-review-checker/deploy.log"
PROJECT_DIR="/home/aswin/pr-review-checker"
APP_NAME="pr-deploy"

echo "$(date): üöÄ Starting production auto-deployment..." | tee -a "$LOG_FILE"
cd "$PROJECT_DIR"

echo "$(date): üì• Pulling latest changes from Git..." | tee -a "$LOG_FILE"
git pull origin main 2>&1 | tee -a "$LOG_FILE"

echo "$(date): üì¶ Installing root dependencies..." | tee -a "$LOG_FILE"
npm ci 2>&1 | tee -a "$LOG_FILE" || npm install 2>&1 | tee -a "$LOG_FILE"

echo "$(date): üé® Installing client dependencies..." | tee -a "$LOG_FILE"
cd client && npm ci 2>&1 | tee -a "$LOG_FILE" || npm install 2>&1 | tee -a "$LOG_FILE"
echo "$(date): üî® Building client app..." | tee -a "$LOG_FILE"
npm run build 2>&1 | tee -a "$LOG_FILE"
cd ..

echo "$(date): ‚öôÔ∏è Installing server dependencies..." | tee -a "$LOG_FILE"
cd server && npm ci 2>&1 | tee -a "$LOG_FILE" || npm install 2>&1 | tee -a "$LOG_FILE"
cd ..

echo "$(date): üîÑ Restarting backend service..." | tee -a "$LOG_FILE"
sudo systemctl restart "$APP_NAME" 2>&1 | tee -a "$LOG_FILE"

echo "$(date): ‚úÖ Deployment completed successfully!" | tee -a "$LOG_FILE"

# Optional: Add health check
echo "$(date): üîç Performing health check..." | tee -a "$LOG_FILE"
sleep 5
if curl -f http://localhost:3001/health > /dev/null 2>&1; then
    echo "$(date): ‚úÖ Health check passed" | tee -a "$LOG_FILE"
else
    echo "$(date): ‚ö†Ô∏è Health check failed - service may still be starting" | tee -a "$LOG_FILE"
fi 