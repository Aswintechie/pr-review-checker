#!/bin/bash
set -e

echo "ðŸš€ Starting auto-deploy process for PR Review Checker..."

# Navigate to the project directory
cd /home/aswin/pr-review-checker

# Pull latest changes from main branch
echo "ðŸ“¥ Pulling latest changes..."
git fetch origin
git reset --hard origin/main

# Install/update dependencies
echo "ðŸ“¦ Installing dependencies..."
npm install

# Build the client application
echo "ðŸ”¨ Building client application..."
cd client
npm install
npm run build
cd ..

# Restart the application (choose one method based on your setup)

# Option 1: If using PM2
echo "ðŸ”„ Restarting with PM2..."
if command -v pm2 &> /dev/null; then
    pm2 restart pr-review-checker || pm2 start server/index.js --name pr-review-checker
else
    echo "âš ï¸ PM2 not found, skipping PM2 restart"
fi

# Option 2: If using systemd (uncomment if needed)
# echo "ðŸ”„ Restarting with systemd..."
# sudo systemctl restart pr-review-checker

# Option 3: If using Docker (uncomment if needed)
# echo "ðŸ”„ Restarting with Docker..."
# docker-compose down
# docker-compose up -d

# Check if the application is running
echo "ðŸ” Checking application status..."
sleep 5

# Test the health endpoint
if curl -f http://localhost:3001/health > /dev/null 2>&1; then
    echo "âœ… Application is running successfully!"
    echo "ðŸŒ Health check passed: http://localhost:3001/health"
else
    echo "âŒ Application health check failed!"
    echo "ðŸ” Checking logs..."
    
    # Show recent logs if available
    if command -v pm2 &> /dev/null; then
        pm2 logs pr-review-checker --lines 20
    fi
    
    exit 1
fi

echo "ðŸŽ‰ Auto-deploy completed successfully!"
echo "ðŸ“… Deployment time: $(date)" 