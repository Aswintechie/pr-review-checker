#!/bin/bash
<<<<<<< HEAD
# auto-deploy.sh - Production deployment script for pr-review-checker

set -e  # Exit on error

LOG_FILE="/home/aswin/pr-review-checker/deploy.log"
PROJECT_DIR="/home/aswin/pr-review-checker"
APP_NAME="pr-deploy"

echo "$(date): ğŸš€ Starting production auto-deployment..." | tee -a "$LOG_FILE"
cd "$PROJECT_DIR"

echo "$(date): ğŸ“¥ Pulling latest changes from Git..." | tee -a "$LOG_FILE"
git pull origin main 2>&1 | tee -a "$LOG_FILE"

echo "$(date): ğŸ“¦ Installing root dependencies..." | tee -a "$LOG_FILE"
npm ci 2>&1 | tee -a "$LOG_FILE" || npm install 2>&1 | tee -a "$LOG_FILE"

echo "$(date): ğŸ¨ Installing client dependencies..." | tee -a "$LOG_FILE"
cd client && npm ci 2>&1 | tee -a "$LOG_FILE" || npm install 2>&1 | tee -a "$LOG_FILE"
echo "$(date): ğŸ”¨ Building client app..." | tee -a "$LOG_FILE"
npm run build 2>&1 | tee -a "$LOG_FILE"
cd ..

echo "$(date): âš™ï¸ Installing server dependencies..." | tee -a "$LOG_FILE"
cd server && npm ci 2>&1 | tee -a "$LOG_FILE" || npm install 2>&1 | tee -a "$LOG_FILE"
cd ..

echo "$(date): ğŸ”„ Restarting backend service..." | tee -a "$LOG_FILE"
sudo systemctl restart "$APP_NAME" 2>&1 | tee -a "$LOG_FILE"

echo "$(date): âœ… Deployment completed successfully!" | tee -a "$LOG_FILE"

# Optional: Add health check
echo "$(date): ğŸ” Performing health check..." | tee -a "$LOG_FILE"
sleep 5
if curl -f http://localhost:3001/health > /dev/null 2>&1; then
    echo "$(date): âœ… Health check passed" | tee -a "$LOG_FILE"
else
    echo "$(date): âš ï¸ Health check failed - service may still be starting" | tee -a "$LOG_FILE"
fi 
=======
set -e

# Get deployment parameters (set by GitHub Actions)
DEPLOY_ENV=${DEPLOY_ENV:-"production"}
FORCE_DEPLOY=${FORCE_DEPLOY:-"false"}

echo "ğŸš€ Starting auto-deploy process for PR Review Checker..."
echo "ğŸ“‹ Environment: $DEPLOY_ENV"
echo "ğŸ”§ Force deploy: $FORCE_DEPLOY"

# Navigate to the project directory
cd /home/aswin/pr-review-checker

# Check if there are changes to deploy (unless force deploy is enabled)
if [ "$FORCE_DEPLOY" = "false" ]; then
    echo "ğŸ” Checking for changes..."
    git fetch origin
    
    # Check if local is behind remote
    if git rev-list HEAD...origin/main --count | grep -q "^0$"; then
        echo "âœ… No new changes to deploy"
        echo "ğŸ’¡ Use 'Force deploy' option to deploy anyway"
        exit 0
    fi
fi

# Pull latest changes from main branch
echo "ğŸ“¥ Pulling latest changes..."
git fetch origin
git reset --hard origin/main

# Show current commit info
echo "ğŸ“ Current commit: $(git log -1 --oneline)"

# Install/update dependencies
echo "ğŸ“¦ Installing dependencies..."
npm install

# Build the client application
echo "ğŸ”¨ Building client application..."
cd client
npm install
npm run build
cd ..

# Environment-specific deployment logic
if [ "$DEPLOY_ENV" = "staging" ]; then
    echo "ğŸ”„ Deploying to staging environment..."
    # Add staging-specific logic here
    # e.g., different ports, different PM2 app name, etc.
    PM2_APP_NAME="pr-review-checker-staging"
else
    echo "ğŸ”„ Deploying to production environment..."
    PM2_APP_NAME="pr-review-checker"
fi

# Restart the application (choose one method based on your setup)

# Option 1: If using PM2
echo "ğŸ”„ Restarting with PM2..."
if command -v pm2 &> /dev/null; then
    pm2 restart $PM2_APP_NAME || pm2 start server/index.js --name $PM2_APP_NAME
else
    echo "âš ï¸ PM2 not found, skipping PM2 restart"
fi

# Option 2: If using systemd (uncomment if needed)
# echo "ğŸ”„ Restarting with systemd..."
# sudo systemctl restart pr-review-checker

# Option 3: If using Docker (uncomment if needed)
# echo "ğŸ”„ Restarting with Docker..."
# docker-compose down
# docker-compose up -d

# Check if the application is running
echo "ğŸ” Checking application status..."
sleep 5

# Test the health endpoint
if curl -f http://localhost:3001/health > /dev/null 2>&1; then
    echo "âœ… Application is running successfully!"
    echo "ğŸŒ Health check passed: http://localhost:3001/health"
    echo "ğŸ“Š Environment: $DEPLOY_ENV"
else
    echo "âŒ Application health check failed!"
    echo "ğŸ” Checking logs..."
    
    # Show recent logs if available
    if command -v pm2 &> /dev/null; then
        pm2 logs $PM2_APP_NAME --lines 20
    fi
    
    exit 1
fi

echo "ğŸ‰ Auto-deploy completed successfully!"
<<<<<<< HEAD
echo "ğŸ“… Deployment time: $(date)" 
>>>>>>> 40a43ce (ğŸš€ Add auto-deploy GitHub Action for VM deployment)
=======
echo "ğŸ“… Deployment time: $(date)"
echo "ğŸŒ Environment: $DEPLOY_ENV" 
>>>>>>> 91a4749 (ğŸ›ï¸ Add manual trigger support with environment and force deploy options)
